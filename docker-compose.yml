services:
  postgres:
    image: postgres:16
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: audit
      POSTGRES_PASSWORD: auditpass
      POSTGRES_DB: auditlog

  audit:
    build: ./audit
    depends_on:
      - postgres
    environment:
      AUDIT_DB_DSN: postgres://audit:auditpass@postgres:5432/auditlog?sslmode=disable
      AUDIT_GRPC_ADDR: ":50051"
    ports:
      - "50051:50051"
  ingestion:
    build: ./ingestion
    ports:
    - "8001:8001"
    environment:
    - QDRANT_URL=${QDRANT_URL}
    depends_on:
      - qdrant
    volumes:
      - ./data/ingestion:/app/data
  qdrant:
    image: qdrant/qdrant:v1.12.3
    ports:
      - "6333:6333"
    volumes:
      - ./data/qdrant:/qdrant/storage
  query:
    build: ./query
    ports:
      - "50052:50052"
    environment:
      - QDRANT_URL=http://qdrant:6333
    depends_on:
      - qdrant
  orchestrator:
    build:
      context: .
      dockerfile: orchestrator/Dockerfile
    ports:
      - "8080:8080"
    environment:
      - ORCH_HTTP_ADDR=:8080
      - QUERY_GRPC_ADDR=query:50052
      - AUDIT_GRPC_ADDR=audit:50051
      - LLM_MODEL=llama3
    depends_on:
      - query
      - audit


